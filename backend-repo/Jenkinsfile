pipeline {
    agent any

    parameters {
        string(name: 'GIT_REF', defaultValue: '', description: 'refs/heads/<branch>')
    }

    environment {
        // ê³µí†µ ì´ë¯¸ì§€ ì´ë¦„
        DOCKER_IMAGE_NAME    = "review/backend-app"

        // ë„¤íŠ¸ì›Œí¬ ë¶„ë¦¬
        TEST_NETWORK         = "test-net"
        PROD_NETWORK         = "prod-net"

        // í˜¸ìŠ¤íŠ¸ í¬íŠ¸
        TEST_PORT            = "8444"
        PROD_PORT            = "8443"

        // ì»¨í…Œì´ë„ˆ ì´ë¦„
        TEST_CONTAINER       = "review-BE-test"
        PROD_BLUE_CONTAINER  = "review-BE-prod-blue"
        PROD_GREEN_CONTAINER = "review-BE-prod-green"

        CPU_SET              = "1,3"
    }

    stages {
        stage('Determine Branch') {
            steps {
                script {
                    env.ACTUAL_BRANCH = params.GIT_REF.replaceFirst(/^refs\/heads\//, '')
                    echo "â–¶ Deploy branch: ${env.ACTUAL_BRANCH}"
                }
            }
        }

        stage('Inject application.yml') {
            when { expression { env.ACTUAL_BRANCH in ['develop-be'] } }
            steps {
                withCredentials([file(credentialsId: 'application.yml', variable: 'APP_YML')]) {
                    echo "ğŸ“„ Copying secret application.yml into resources"
                    sh '''
                        # ë¦¬ì†ŒìŠ¤ í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
                        mkdir -p backend-repo/src/main/resources
                        chmod -R u+w backend-repo/src/main/resources
                        # application.yml ë®ì–´ì“°ê¸°
                        cp "$APP_YML" backend-repo/src/main/resources/application.yml
                    '''
                }
            }
        }

        stage('Inject application-docker.yml') {
            when { expression { env.ACTUAL_BRANCH in ['develop-be'] } }
            steps {
                withCredentials([file(credentialsId: 'application-docker.yml', variable: 'APP_YML_DOCKER')]) {
                    echo "ğŸ“„ Copying secret application-docker.yml into resources"
                    sh '''
                        # ë¦¬ì†ŒìŠ¤ í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
                        mkdir -p backend-repo/src/main/resources
                        chmod -R u+w backend-repo/src/main/resources
                        # application.yml ë®ì–´ì“°ê¸°
                        cp "$APP_YML_DOCKER" backend-repo/src/main/resources/application-docker.yml
                    '''
                }
            }
        }
        stage('Inject application-prod.yml') {
            when { expression { env.ACTUAL_BRANCH in ['main-be'] } }
            steps {
                withCredentials([file(credentialsId: 'application-prod.yml', variable: 'APP_YML')]) {
                    echo "ğŸ“„ Copying secret application.yml into resources"
                    sh '''
                        # ë¦¬ì†ŒìŠ¤ í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
                        mkdir -p backend-repo/src/main/resources
                        chmod -R u+w backend-repo/src/main/resources
                        # application.yml ë®ì–´ì“°ê¸°
                        cp "$APP_YML" backend-repo/src/main/resources/application.yml
                    '''
                }
            }
        }

        stage('Inject application-docker-prod.yml') {
            when { expression { env.ACTUAL_BRANCH in ['main-be'] } }
            steps {
                withCredentials([file(credentialsId: 'application-docker-prod.yml', variable: 'APP_YML_DOCKER')]) {
                    echo "ğŸ“„ Copying secret application-docker.yml into resources"
                    sh '''
                        # ë¦¬ì†ŒìŠ¤ í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
                        mkdir -p backend-repo/src/main/resources
                        chmod -R u+w backend-repo/src/main/resources
                        # application.yml ë®ì–´ì“°ê¸°
                        cp "$APP_YML_DOCKER" backend-repo/src/main/resources/application-docker.yml
                    '''
                }
            }
        }

        stage('Build') {
            when { expression { env.ACTUAL_BRANCH in ['develop-be','main-be'] } }
            steps {
                dir('backend-repo') {
                    echo "ğŸš€ Building on ${env.ACTUAL_BRANCH}"
                    sh '''
                        chmod +x ./gradlew
                        ./gradlew --no-daemon build -x test
                    '''
                }
            }
        }

        stage('Test') {
            when { expression { env.ACTUAL_BRANCH == 'develop-be' } }
            steps {
                dir('backend-repo') {
                    echo "ğŸ§ª Running tests on develop-be"
                    sh './gradlew --no-daemon test'
                }
            }
        }

        stage('Prepare Networks') {
            steps {
                // ì—†ìœ¼ë©´ ìƒì„±
                sh """
                    docker network create ${TEST_NETWORK} || true
                    docker network create ${PROD_NETWORK} || true
                """
            }
        }

        stage('Deploy to Test Env') {
            when { expression { env.ACTUAL_BRANCH == 'develop-be' } }
            steps {
                script {
                    def tag = "${DOCKER_IMAGE_NAME}:dev-${BUILD_NUMBER}"
                    echo "ğŸ³ Building test image ${tag}"
                    sh "docker build -t ${tag} backend-repo"

                    echo "ğŸš€ Deploying TEST container (${TEST_CONTAINER}) on port ${TEST_PORT}"
                    sh """
                        docker rm -f ${TEST_CONTAINER} || true
                        docker run -d \\
                            --name ${TEST_CONTAINER} \\
                            --cpuset-cpus=${CPU_SET} \\
                            --network ${TEST_NETWORK} --network-alias backend-test \\
                            -e SPRING_PROFILES_ACTIVE=docker \\
                            -p ${TEST_PORT}:8080 \\
                            ${tag}
                    """
                }
            }
        }

        stage('Deploy (Blue/Green) to Prod') {
            when { expression { env.ACTUAL_BRANCH == 'main-be' } }
            steps {
                script {
                    def tag      = "${DOCKER_IMAGE_NAME}:prod-${BUILD_NUMBER}"
                    def blueName = PROD_BLUE_CONTAINER
                    def greenName= PROD_GREEN_CONTAINER

                    // í˜„ì¬ Active ì¸¡ ê²€ì‚¬ (blue first)
                    def active   = sh(
                        script: "docker ps -q --filter name=${blueName}",
                        returnStdout: true
                    ).trim() ? blueName : greenName
                    def inactive = (active == blueName) ? greenName : blueName

                    echo "ğŸ³ Building prod image ${tag}"
                    sh "docker build -t ${tag} backend-repo"

                    echo "ğŸš€ Deploying PROD container (${inactive}) on port ${PROD_PORT}"
                    sh """
                        docker rm -f ${inactive} || true
                        docker run -d \\
                            --name ${inactive} \\
                            --cpuset-cpus=${CPU_SET} \\
                            --network ${PROD_NETWORK} --network-alias backend \\
                            -e SPRING_PROFILES_ACTIVE=docker \\
                            -p ${PROD_PORT}:8080 \\
                            ${tag}
                    """

                    echo "ğŸ” Health check on port ${PROD_PORT}"
                    sh """
                        for i in {1..10}; do
                            sleep 3
                            curl -f http://localhost:${PROD_PORT}/actuator/health && break
                            if [ \$i -eq 10 ]; then
                                echo 'âŒ Health check failed'; exit 1
                            fi
                        done
                    """

                    echo "ğŸ›‘ Stopping old active container: ${active}"
                    sh "docker stop ${active} || true"
                    echo "âœ… Production switched to ${inactive}"
                }
            }
        }
    }

    post {
        always {
            echo "ğŸ“¦ Pipeline finished with status: ${currentBuild.currentResult}"
        }
    }
}
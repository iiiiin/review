pipeline {
    agent any

    parameters {
        string(name: 'GIT_REF', defaultValue: '', description: 'refs/heads/<branch>')
    }

    environment {
        DOCKER_IMAGE_NAME = "review/frontend-app"
        TEST_NETWORK      = "test-net"
        PROD_NETWORK      = "prod-net"
        TEST_PORT         = "8085"
        TEST_SSL_PORT     = "8445"
        PROD_PORT         = "80"
        PROD_SSL_PORT     = "443"
        TEST_CONTAINER    = "review-FE-test"
        PROD_CONTAINER    = "review-FE-prod"
        CERT_PATH         = "/etc/letsencrypt/live/i13e206.p.ssafy.io"
        CPU_SET           = "1,3"
    }

    stages {
        stage('Determine Branch') {
            steps {
                script {
                    env.ACTUAL_BRANCH = params.GIT_REF.replaceFirst(/^refs\/heads\//, '')
                    echo "‚ñ∂ Branch = ${env.ACTUAL_BRANCH}"

                    // üî• Ï∂îÍ∞Ä: Jenkins Global ÌôòÍ≤ΩÎ≥ÄÏàò ÌôïÏù∏
                    echo "‚ñ∂ API URL from Jenkins Global: ${env.VITE_API_BASE_URL}"
                }
            }
        }

        stage('Prepare Networks') {
            steps {
                sh """
                    docker network create ${TEST_NETWORK} || true
                    docker network create ${PROD_NETWORK} || true
                """
            }
        }

        stage('Deploy to Test Env') {
            when { expression { env.ACTUAL_BRANCH == 'develop-fe' } }
            steps {
                dir('frontend-repo') {
                    script {
                        def tag = "${DOCKER_IMAGE_NAME}:test-${BUILD_NUMBER}"
                        echo "üê≥ Building TEST image ${tag}"

                        // üî• ÏàòÏ†ï: Jenkins Global ÌôòÍ≤ΩÎ≥ÄÏàòÎ•º Docker ÎπåÎìúÏóê Ï†ÑÎã¨
                        sh """
                            docker build \\
                                --build-arg ENV=test \\
                                --build-arg VITE_API_BASE_URL="${env.VITE_API_BASE_URL}" \\
                                -t ${tag} .
                        """

                        echo "üöÄ Running TEST container ${TEST_CONTAINER}"
                        sh """
                            docker rm -f ${TEST_CONTAINER} || true
                            docker run -d \\
                                --name ${TEST_CONTAINER} \\
                                --cpuset-cpus=${CPU_SET} \\
                                --network ${TEST_NETWORK} \\
                                -p ${TEST_PORT}:80 \\
                                -p ${TEST_SSL_PORT}:443 \\
                                -v ${CERT_PATH}/fullchain.pem:/etc/nginx/certs/fullchain.pem:ro \\
                                -v ${CERT_PATH}/privkey.pem:/etc/nginx/certs/privkey.pem:ro \\
                                ${tag}
                        """
                    }
                }
            }
        }

        stage('Deploy to Prod Env') {
            when { expression { env.ACTUAL_BRANCH == 'main-fe' } }
            steps {
                dir('frontend-repo') {
                    script {
                        def tag = "${DOCKER_IMAGE_NAME}:prod-${BUILD_NUMBER}"
                        echo "üê≥ Building PROD image ${tag}"

                        // üî• ÏàòÏ†ï: Jenkins Global ÌôòÍ≤ΩÎ≥ÄÏàòÎ•º Docker ÎπåÎìúÏóê Ï†ÑÎã¨
                        sh """
                            docker build \\
                                --build-arg ENV=prod \\
                                --build-arg VITE_API_BASE_URL="${env.VITE_API_BASE_URL}" \\
                                -t ${tag} .
                        """

                        echo "üöÄ Running PROD container ${PROD_CONTAINER}"
                        sh """
                            docker rm -f ${PROD_CONTAINER} || true
                            docker run -d \\
                                --name ${PROD_CONTAINER} \\
                                --cpuset-cpus=${CPU_SET} \\
                                --network ${PROD_NETWORK} \\
                                -p ${PROD_PORT}:80 \\
                                -p ${PROD_SSL_PORT}:443 \\
                                -v ${CERT_PATH}/fullchain.pem:/etc/nginx/certs/fullchain.pem:ro \\
                                -v ${CERT_PATH}/privkey.pem:/etc/nginx/certs/privkey.pem:ro \\
                                ${tag}
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            echo "üì¶ Frontend pipeline finished with status: ${currentBuild.currentResult}"
        }
    }
}
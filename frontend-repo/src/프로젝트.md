# 인터뷰 시스템 아키텍처 및 구현 분석

## 1. 전체 구조 개요

이 프로젝트는 AI 기반 면접 서비스로, 사용자가 면접 설정부터 실제 면접 진행, 분석 결과 확인까지의 전체 플로우를 제공합니다.

### 주요 페이지 구성
```
📁 src/pages/Interview*/
├── 📁 InterviewGuide/      # 면접 준비 및 가이드 
├── 📁 InterviewSetup/      # 면접 설정 (회사, 직무, 문서 업로드)
├── 📁 InterviewLoading/    # 면접 로딩 화면 (질문 생성 중)
└── 📁 InterviewSession/    # 실제 면접 진행
```

## 2. 면접 플로우 상세 분석

### 2.1 InterviewSetup - 면접 설정 단계

**주요 파일**: `InterviewSetupPage.tsx`, `InterviewSetupStore.ts`

**기능**:
- 면접 유형 선택 (직무, 인성, PT)
- 회사/직무 정보 입력
- 이력서, 포트폴리오, 대본 파일 업로드
- 질문 개수 설정 (1-10개)

**상태 관리 (Zustand)**:
```typescript
interface InterviewSetupState {
  currentStep: number;           // 현재 설정 단계
  interviewType: string;         // 면접 유형
  company: { uuid: string; name: string };
  job: { uuid: string; name: string };
  resume: DocumentState;         // 이력서 파일 및 UUID
  portfolio: DocumentState;      // 포트폴리오 파일 및 UUID
  script: DocumentState;         // 대본 파일 및 UUID
  questionCount: number;         // 질문 개수
}
```

**핵심 로직**:
- `uploadInterviewFiles()`: 파일 업로드 후 UUID 반환
- 페이지 벗어날 때 상태 자동 초기화

### 2.2 InterviewGuide - 면접 가이드 및 시작

**주요 파일**: `InterviewGuidePage.tsx`, `InterviewGuideContent.tsx`

**기능**:
- 면접 안내사항 표시
- 장비 테스트 (카메라, 마이크)
- 면접 시작 처리

**핵심 플로우**:
1. URL 파라미터에서 면접 정보 추출
2. 장비 테스트 완료 확인
3. `/api/interview/start` 호출하여 면접 세션 생성
4. PT 면접의 경우: start 응답에서 바로 질문 정보 획득
5. 직무/인성 면접의 경우: `generateQuestions` 호출하여 첫 번째 질문 세트 생성
6. SessionStorage에 면접 데이터 저장 (`REVIEW_SESSION_${uuid}`)
7. 3초 카운트다운 후 InterviewSession으로 이동

**저장 데이터 구조**:
```typescript
interface StoredSessionData {
  interviewUuid: string;
  interviewType: 'JOB' | 'TENACITY' | 'PT';
  recruitUuid?: string;
  resumeUuid?: string;
  portfolioUuid?: string;
  scriptFileUuid?: string;
  interviewSetUuid?: string;    // 직무/인성용
  questions?: any[];            // 질문 배열
  ptInitial: {                  // PT용
    questionUuid?: string;
    title?: string | null;
    situation?: string | null;
  };
  processingTimeMs?: number;
  createdAt: number;
  totalInterviewSets?: number;
}
```

### 2.3 InterviewLoading - 로딩 및 전환

**주요 파일**: `InterviewLoadingPage.tsx`

**기능**:
- 질문 생성 진행 상황 표시
- SessionStorage 폴링을 통한 준비 상태 확인
- 자동 전환 처리

**단계별 처리**:
1. **prewait**: 최소 5초 대기
2. **polling**: SessionStorage에서 `ready: true` 확인 (최대 2분)
3. **countdown**: 5초 카운트다운
4. **done**: 세션 페이지로 이동

### 2.4 InterviewSession - 실제 면접 진행

**주요 파일**: `InterviewSessionPage.tsx`, `InterviewSession.tsx`

**핵심 컴포넌트**:
- **InterviewSession**: 메인 면접 진행 컴포넌트
- **useOpenVidu**: OpenVidu 화상회의 관리
- **useWebSocket**: 실시간 분석 결과 수신

## 3. 핵심 기술 스택 및 구현 상세

### 3.1 상태 관리

**useReducer 기반 상태 관리**:
```typescript
interface InterviewState {
  step: 'loading' | 'preparing' | 'recording-prep' | 'answering' | 'complete';
  questions: ExpandedQ[];
  currentQuestionIndex: number;
  remainingTime: number;
  resultId: string | null;
  currentRecordingId: string | null;
  isPreparingRecording: boolean;
}
```

**주요 액션**:
- `START_RECORDING_PREP`: 녹화 준비 단계로 전환
- `SET_RECORDING_ID`: 녹화 ID 설정 시 자동으로 answering 단계로 전환
- `NEXT_QUESTION`: 다음 질문으로 이동
- `COMPLETE_INTERVIEW`: 면접 완료

### 3.2 OpenVidu 화상회의 통합

**useOpenVidu Hook**:
- 세션 생성 및 연결
- Publisher/Subscriber 관리
- 카메라/마이크 제어
- 세션 종료 시 미디어 트랙 정리

**핵심 기능**:
```typescript
const { 
  session, 
  publisher, 
  subscribers, 
  joinSession, 
  leaveSession, 
  isSessionReady 
} = useOpenVidu(mySessionId, myUserName);
```

### 3.3 WebSocket 실시간 통신

**useWebSocket Hook**:
- STOMP 프로토콜 기반
- JWT 토큰 인증
- 사용자별 토픽 구독

**구독 토픽**:
- `/topic/users/${userUuid}/analysis-results`: 일반 분석 결과
- `/topic/users/${userUuid}/transcript-results`: 전사 결과
- `/topic/users/${userUuid}/pt-analysis-results`: PT 전용 분석
- `/topic/users/${userUuid}/pt-feedback-completed`: PT 피드백 완료

### 3.4 API 클라이언트 및 인증

**apiClient (Axios 기반)**:
- 자동 토큰 갱신 (Access Token + Refresh Token)
- 401 에러 시 자동 토큰 재발급
- 큐 시스템으로 중복 갱신 방지

**인터셉터 구조**:
- 요청 인터셉터: Authorization 헤더 자동 추가
- 응답 인터셉터: 토큰 만료 시 자동 갱신

## 4. 녹화 및 분석 플로우

### 4.1 녹화 시작 개선사항

**기존 문제점**: "답변 시작" 버튼 클릭 시 즉시 답변 화면으로 전환

**개선된 플로우**:
1. "답변 시작" 버튼 → "녹화 준비 중" 상태로 변경
2. 스피너 표시 및 알림 메시지 출력
3. `currentRecordingId` 설정 시 자동으로 답변 화면으로 전환
4. 답변 중 "REC" 표시

**구현 세부사항**:
```typescript
// 녹화 준비 단계
case 'START_RECORDING_PREP':
  return { ...state, step: 'recording-prep' };

// 녹화 ID 설정 시 자동 전환
useEffect(() => {
  if (state.step === 'recording-prep' && state.currentRecordingId) {
    dispatch({ type: 'SET_STEP', payload: 'answering' });
  }
}, [state.step, state.currentRecordingId]);
```

### 4.2 분석 결과 처리

**TanStack Query 활용**:
- `fetchInterviewFeedback`: 면접 피드백 조회
- 낙관적 업데이트 및 캐싱
- 에러 처리 및 재시도 로직

**WebSocket 연동**:
- 분석 완료 시 실시간 알림
- `answerAttemptId` 기반 결과 매칭
- PT 면접 전용 토픽 별도 처리

## 5. 특수 케이스 및 예외 처리

### 5.1 꼬리질문 처리

**현재 이슈**: 꼬리질문에서 녹화가 제대로 시작되지 않는 문제

**근본 원인**: `handleNextQuestion` 함수에서 같은 세트 내 질문 전환 시에도 녹화를 중단하는 로직

**해결 방안**: 메인 질문과 꼬리질문 구분하여 녹화 제어 개선 필요

### 5.2 에러 처리 및 복구

**타임아웃 처리**:
- 질문 생성: 60초 → 90초 재시도
- API 클라이언트: 10초 기본 타임아웃

**WebSocket 연결**:
- 자동 재연결 (5초 간격)
- Heartbeat을 통한 연결 유지

## 6. 성능 최적화 요소

### 6.1 메모리 관리

**OpenVidu 세션 정리**:
- 페이지 이탈 시 미디어 트랙 정리
- `beforeunload` 이벤트 처리

**상태 초기화**:
- InterviewSetup 페이지 이탈 시 Zustand 스토어 초기화
- SessionStorage 적절한 활용

### 6.2 사용자 경험

**로딩 화면**:
- 진행 상황 시각화
- 면접 팁 로테이션
- 애니메이션 효과

**자동 전환**:
- 준비 완료 시 자동 세션 시작
- 녹화 준비 완료 시 자동 답변 화면 전환

## 7. 보안 및 인증

### 7.1 토큰 관리

**이중 토큰 시스템**:
- Access Token: 메모리 저장, 짧은 만료 시간
- Refresh Token: HttpOnly 쿠키, 긴 만료 시간

**자동 갱신**:
- 401 에러 감지 시 자동 토큰 갱신
- 갱신 실패 시 로그인 페이지 리다이렉션

### 7.2 WebSocket 보안

**JWT 기반 인증**:
- 연결 시 Authorization 헤더로 토큰 전송
- 사용자별 토픽 구독으로 권한 분리

## 8. 향후 개선 방향

### 8.1 꼬리질문 녹화 이슈 해결
- 질문 타입별 녹화 제어 로직 분리
- 세트 내/세트 간 전환 구분

### 8.2 실시간 피드백 강화
- WebSocket 메시지 타입 확장
- 진행 상황 실시간 업데이트

### 8.3 사용자 경험 개선
- 더 정교한 로딩 상태 표시
- 에러 상황 사용자 안내 강화